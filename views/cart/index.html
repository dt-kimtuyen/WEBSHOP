<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="/css/cart.css">
    <script>
        // Khi trang được tải xong, lấy giỏ hàng từ session và hiển thị
        document.addEventListener('DOMContentLoaded', function () {
            fetch('/cart')  // Gửi yêu cầu GET đến API để lấy giỏ hàng
                .then(response => response.json())
                .then(cart => {
                    const cartContainer = document.querySelector('.cart-container');
                    const totalPriceElement = document.querySelector('.total-price');
                    let totalPrice = 0;

                    // Kiểm tra nếu giỏ hàng rỗng
                    if (cart.length === 0) {
                        cartContainer.innerHTML = '<p>Your cart is empty.</p>';
                    } else {
                        // Lặp qua từng sản phẩm trong giỏ và hiển thị
                        cart.forEach(item => {
                            const cartItem = document.createElement('div');
                            cartItem.classList.add('cart-item');
                            cartItem.setAttribute('data-id', item.product_id); // Lưu ID sản phẩm

                            // Tạo nội dung cho mỗi mục trong giỏ
                            cartItem.innerHTML = `
                                <img src="/uploads${item.image_path ? item.image_path : '/images/default.jpg'}" alt="${item.name}">
                                <div class="cart-item-info">
                                    <h3>${item.name}</h3>
                                    <p>Price: $${item.price}</p>
                                    <p>Quantity: 
                                        <input type="number" value="${item.quantity}" min="1" class="quantity-input" data-id="${item.product_id}">
                                    </p>
                                    <button class="remove-item" data-id="${item.product_id}">Remove</button>
                                </div>
                            `;
                            cartContainer.appendChild(cartItem);

                            // Tính tổng giá trị giỏ hàng
                            totalPrice += item.price * item.quantity;
                        });

                        // Hiển thị tổng tiền
                        totalPriceElement.textContent = `Total Price: $${totalPrice.toFixed(2)}`;
                    }

                    // Xử lý sự kiện thay đổi số lượng sản phẩm
                    const quantityInputs = document.querySelectorAll('.quantity-input');
                    quantityInputs.forEach(input => {
                        input.addEventListener('change', function () {
                            const productId = this.getAttribute('data-id');
                            const newQuantity = parseInt(this.value);

                            // Gửi yêu cầu cập nhật số lượng sản phẩm
                            fetch('/cart/update', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    product_id: productId,
                                    quantity: newQuantity,
                                }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    alert('Cart updated');
                                    location.reload();  // Làm mới trang sau khi cập nhật
                                } else {
                                    alert('Failed to update cart.');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('An error occurred while updating the cart.');
                            });
                        });
                    });

                    // Xử lý sự kiện xóa sản phẩm khỏi giỏ
                    const removeButtons = document.querySelectorAll('.remove-item');
                    removeButtons.forEach(button => {
                        button.addEventListener('click', function () {
                            const productId = this.getAttribute('data-id');

                            // Gửi yêu cầu xóa sản phẩm khỏi giỏ hàng
                            fetch('/cart/remove', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ product_id: productId }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    alert('Product removed from cart');
                                    location.reload();  // Làm mới trang sau khi xóa sản phẩm
                                } else {
                                    alert('Failed to remove product from cart.');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('An error occurred while removing the product.');
                            });
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching cart:', error);
                    alert('Failed to load cart.');
                });
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>Your Shopping Cart</h1>

        <div class="cart-container">
            <!-- Các sản phẩm trong giỏ sẽ được chèn vào đây thông qua JavaScript -->
        </div>

        <div class="total-price">
            <!-- Tổng tiền giỏ hàng sẽ được hiển thị ở đây -->
        </div>

        <button class="checkout-btn">Proceed to Checkout</button>
    </div>

    <script type="text/javascript" src="/js/script.js"></script>
</body>
</html>
